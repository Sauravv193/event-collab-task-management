import{u as e,c as s,j as a,b as t}from"./query-CYHn1j2-.js";import{r}from"./react-vendor-BU4UtguS.js";import{a as i,z as n,B as d,c as l,u as o,L as c}from"./index-DT-T-1C3.js";import{j as m,d as x,b as u,e as h}from"./eventService-B4wxl7w5.js";import{T as g,i as b,m as p,U as y,I as j,g as v,j as k,k as f,l as N}from"./ui-C2-6eSzT.js";import{d as w,c as C}from"./router-BmPrQWNH.js";import"./utils-ki6RHjvQ.js";const S=async({taskData:e,eventId:s})=>{const{data:a}=await i.post(`/tasks/event/${s}`,e);return a},T=async({taskId:e,taskDetails:s})=>{const{data:a}=await i.put(`/tasks/${e}`,s);return a},q=async e=>(await i.delete(`/tasks/${e}`),e),D=({task:t,eventId:r,isCreator:i})=>{const d=e(),l=s({mutationFn:T,onSuccess:()=>{d.invalidateQueries({queryKey:["tasks",r]})},onError:e=>{n.error(e.response?.data?.message||"Failed to update task.")}}),o=s({mutationFn:q,onSuccess:()=>{n.success("Task deleted!")},onError:e=>{n.error(e.response?.data?.message||"You do not have permission to delete this task.")}});return a.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-100 dark:bg-gray-700 rounded-lg",children:[a.jsxs("div",{children:[a.jsx("p",{className:"font-semibold text-gray-900 dark:text-white",children:t.name}),a.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:t.description})]}),a.jsxs("div",{className:"flex items-center gap-4",children:[a.jsxs("select",{value:t.status,onChange:e=>{l.mutate({taskId:t.id,taskDetails:{...t,status:e.target.value}})},className:"rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 shadow-sm text-sm",children:[a.jsx("option",{value:"TO_DO",children:"To Do"}),a.jsx("option",{value:"IN_PROGRESS",children:"In Progress"}),a.jsx("option",{value:"DONE",children:"Done"})]}),i&&a.jsx("button",{onClick:()=>o.mutate(t.id),disabled:o.isPending,className:"text-red-500 hover:text-red-700 disabled:opacity-50",title:"Delete task",children:a.jsx(g,{size:18})})]})]})},E=({eventId:t,onComplete:i})=>{const[l,o]=r.useState(""),[c,m]=r.useState(""),x=e(),u=s({mutationFn:S,onSuccess:()=>{n.success("Task created!"),x.invalidateQueries({queryKey:["tasks",t]}),i()},onError:e=>{n.error(e.response?.data?.message||"Failed to create task.")}});return a.jsxs("form",{onSubmit:e=>{if(e.preventDefault(),!l.trim())return void n.error("Task name cannot be empty.");const s={name:l,description:c,status:"TO_DO"};u.mutate({taskData:s,eventId:t})},className:"p-4 my-4 bg-gray-100 dark:bg-gray-700 rounded-lg space-y-3",children:[a.jsx("h3",{className:"font-semibold text-lg text-gray-900 dark:text-white",children:"Add New Task"}),a.jsx("input",{type:"text",placeholder:"Task name (required)",value:l,onChange:e=>o(e.target.value),required:!0,className:"w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 shadow-sm"}),a.jsx("textarea",{placeholder:"Task description (optional)",value:c,onChange:e=>m(e.target.value),className:"w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 shadow-sm"}),a.jsxs("div",{className:"flex justify-end gap-2",children:[a.jsx(d,{type:"button",variant:"ghost",onClick:i,children:"Cancel"}),a.jsx(d,{type:"submit",disabled:u.isPending,children:u.isPending?"Saving...":"Save Task"})]})]})},I=({eventId:e,isMember:s,isCreator:n,isExpired:l})=>{const[o,c]=r.useState(!1),{data:m,isLoading:x,error:u}=t({queryKey:["tasks",e],queryFn:()=>(async e=>{const{data:s}=await i.get(`/tasks/event/${e}`);return s})(e),enabled:s});return a.jsxs("div",{children:[a.jsx("div",{className:"flex justify-end mb-4",children:!o&&!l&&a.jsxs(d,{onClick:()=>c(!0),children:[a.jsx(b,{size:16,className:"mr-2"}),"Add Task"]})}),o&&a.jsx(E,{eventId:e,onComplete:()=>c(!1)}),x&&a.jsx("div",{className:"text-center p-4",children:"Loading tasks..."}),u&&a.jsx("div",{className:"text-red-500 text-center p-4",children:"Could not load tasks."}),!x&&!u&&a.jsx("div",{className:"space-y-3",children:m&&m.length>0?m.map(s=>a.jsx(D,{task:s,eventId:e,isCreator:n},s.id)):a.jsx("p",{className:"text-center text-gray-500 dark:text-gray-400",children:"No tasks have been created yet."})})]})},F=()=>{const{id:i}=w(),b=C(),{stompClient:S}=l(),{user:T}=o(),q=e(),[D,E]=r.useState(""),F=r.useRef(null),{data:K,isLoading:O,error:P}=t({queryKey:["event",i],queryFn:()=>u(i)}),Q=K?.members.some(e=>e.username===T.username),$=K?.createdBy.username===T.username,L=K?.expired,{data:z,isLoading:J}=t({queryKey:["chat",i],queryFn:()=>h(i),enabled:!!K&&Q}),Y=s({mutationFn:m,onSuccess:()=>{n.success("Successfully joined the event!"),q.invalidateQueries({queryKey:["event",i]}),q.invalidateQueries({queryKey:["tasks",i]})},onError:e=>{n.error(e.response?.data?.message||"Failed to join event.")}}),A=s({mutationFn:x,onSuccess:()=>{n.success("Event deleted successfully."),q.invalidateQueries({queryKey:["events"]}),b("/")},onError:e=>{n.error(e.response?.data?.message||"You do not have permission to delete this event.")}});r.useEffect(()=>{F.current?.scrollIntoView({behavior:"smooth"})},[z]),r.useEffect(()=>{if(S&&S.connected&&i&&Q){const e=S.subscribe(`/topic/chat/${i}`,e=>{const s=JSON.parse(e.body);q.setQueryData(["chat",i],e=>e?[...e,s]:[s])}),s=S.subscribe(`/topic/tasks/${i}`,()=>{q.invalidateQueries({queryKey:["tasks",i]})}),a=S.subscribe(`/topic/tasks/deleted/${i}`,()=>{q.invalidateQueries({queryKey:["tasks",i]})});return()=>{e.unsubscribe(),s.unsubscribe(),a.unsubscribe()}}},[S,i,q,Q]);return O?a.jsx(c,{}):P?a.jsx("div",{className:"text-center text-red-500 p-8",children:"Could not load event. It may have been deleted."}):Q?a.jsxs(p.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"container mx-auto p-4",children:[L&&a.jsxs("div",{className:"flex items-center gap-4 bg-yellow-500/10 text-yellow-400 p-4 rounded-lg mb-6",children:[a.jsx(j,{size:20}),a.jsx("p",{children:"This event has finished. You can view the tasks and chat history, but you cannot create new tasks or send messages."})]}),a.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[a.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[a.jsxs("div",{className:"p-6 bg-white dark:bg-white/10 backdrop-blur-xl border border-gray-200 dark:border-white/20 shadow-lg rounded-2xl",children:[a.jsxs("div",{className:"flex justify-between items-start",children:[a.jsxs("div",{children:[a.jsx("h1",{className:"text-4xl font-bold mb-4",children:K.name}),a.jsx("p",{className:"text-gray-600 dark:text-gray-300 mb-6",children:K.description})]}),$&&!L&&a.jsxs(d,{onClick:()=>{window.confirm("Are you sure you want to delete this event? This action cannot be undone.")&&A.mutate(i)},disabled:A.isPending,variant:"outline",className:"text-red-500 hover:bg-red-500/10 border-red-500/50",children:[a.jsx(g,{size:16,className:"mr-2"}),"Delete Event"]})]}),a.jsxs("div",{className:"flex flex-wrap gap-x-6 gap-y-4",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(v,{className:"w-5 h-5 text-indigo-400"})," ",new Date(K.date).toLocaleDateString()]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(k,{className:"w-5 h-5 text-indigo-400"})," ",K.location]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(f,{className:"w-5 h-5 text-indigo-400"})," ",K.members.length," participants"]})]})]}),a.jsxs("div",{className:"p-6 bg-white dark:bg-white/10 backdrop-blur-xl border border-gray-200 dark:border-white/20 shadow-lg rounded-2xl",children:[a.jsx("h2",{className:"text-2xl font-bold mb-4",children:"Tasks"}),a.jsx(I,{eventId:i,isMember:Q,isCreator:$,isExpired:L})]})]}),a.jsxs("div",{className:"lg:col-span-1 flex flex-col h-[80vh] bg-white dark:bg-white/10 backdrop-blur-xl border border-gray-200 dark:border-white/20 shadow-lg rounded-2xl",children:[a.jsx("h2",{className:"text-xl font-bold p-4 border-b border-gray-200 dark:border-white/20",children:"Event Chat"}),a.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[J&&a.jsx("p",{className:"text-center",children:"Loading messages..."}),z?.map((e,s)=>a.jsx("div",{className:"flex "+(e.sender===T.username?"justify-end":"justify-start"),children:a.jsxs("div",{className:"max-w-xs p-3 rounded-lg "+(e.sender===T.username?"bg-indigo-500 text-white":"bg-gray-200 dark:bg-gray-700"),children:[a.jsx("p",{className:"font-bold text-sm",children:e.sender}),a.jsx("p",{children:e.content})]})},s)),z&&0===z.length&&a.jsx("p",{className:"text-center text-gray-400 pt-4",children:"No messages yet. Say hello!"}),a.jsx("div",{ref:F})]}),a.jsxs("form",{onSubmit:e=>{if(e.preventDefault(),D.trim()&&S?.connected&&!L){const e={sender:T.username,content:D};S.publish({destination:`/app/chat.sendMessage/${i}`,body:JSON.stringify(e)}),E("")}},className:"p-4 border-t border-gray-200 dark:border-white/20 flex gap-2",children:[a.jsx("input",{type:"text",placeholder:L?"Chat is closed for this event":"Type a message...",className:"flex-1 w-full px-3 py-2 bg-gray-50 dark:bg-white/5 border border-gray-300 dark:border-white/20 rounded-md placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 disabled:opacity-50",value:D,onChange:e=>E(e.target.value),disabled:L}),a.jsx(d,{type:"submit",className:"p-2",disabled:L,children:a.jsx(N,{className:"w-5 h-5"})})]})]})]})]}):a.jsx(p.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},children:a.jsx("div",{className:"flex items-center justify-center py-20",children:a.jsxs("div",{className:"w-full max-w-2xl p-8 bg-white dark:bg-white/10 backdrop-blur-xl border border-gray-200 dark:border-white/20 shadow-lg rounded-2xl text-center",children:[a.jsx("h1",{className:"text-4xl font-bold mb-4",children:K.name}),L?a.jsx("p",{className:"text-lg text-yellow-400 mb-6",children:"This event has already finished and is no longer open for joining."}):a.jsxs(a.Fragment,{children:[a.jsx("p",{className:"text-lg text-gray-500 dark:text-gray-400 mb-6",children:"You must join this event to see the full details and participate."}),a.jsxs(d,{onClick:()=>Y.mutate(i),disabled:Y.isPending,className:"mx-auto",children:[a.jsx(y,{className:"w-5 h-5 mr-2"}),Y.isPending?"Joining...":"Join Event"]})]})]})})})};export{F as default};
